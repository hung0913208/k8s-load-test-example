# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Verify/Load-Performance-Testing.gitlab-ci.yml

# Read more about the feature here: https://docs.gitlab.com/ee/ci/testing/code_quality.html

stages:
  - build
  - test
  - capture
  - performance
  - approve

.pack:
  stage: build
  image: node:12.13.0
  script:
    - yarn --frozen-lockfile
    - yarn webpack

.benchmark:
  stage: performance
  image: docker:git
  variables:
    K6_VERSION: 0.41.0
    K6_TEST_CASE: ''
    K6_OPTIONS: ''
  services:
    - docker:dind
  script:
    - wget https://github.com/grafana/k6/releases/download/v${K6_VERSION}/k6-v${K6_VERSION}-linux-amd64.tar.gz
    - tar xf k6-v${K6_VERSION}-linux-amd64.tar.gz
    - ./k6-v${K6_VERSION}-linux-amd64/k6           \
            run ${K6_TEST_CASE}                    \
            --summary-export=performance.json      \
            ${K6_OPTIONS}

.capture:
  state:  capture
  image: docker:git
  variables:
    SITESPEED_TEST_CASE: ''
    SITESPEED_VERSION: 14.1.0
    SITESPEED_OPTIONS: ''
  services:
    - docker:stable-dind
  script:
    - mkdir gitlab-exporter
    - wget -O ./gitlab-exporter/index.js https://gitlab.com/gitlab-org/gl-performance/raw/1.1.0/index.js
    - mkdir sitespeed-results
    - |
      docker run --shm-size=1g --rm                                           \
        -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io:$SITESPEED_VERSION \
        --plugins.add ./gitlab-exporter                                       \
        --outputFolder sitespeed-results                                      \
        $SITESPEED_TEST_CASE                                                  \
        $SITESPEED_OPTIONS
    - mv sitespeed-results/data/performance.json performance.json
  artifacts:
    paths:
      - performance.json
      - sitespeed-results/
    reports:
      performance: performance.json
