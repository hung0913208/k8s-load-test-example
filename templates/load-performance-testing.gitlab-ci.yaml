# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Verify/Load-Performance-Testing.gitlab-ci.yml

# Read more about the feature here: https://docs.gitlab.com/ee/ci/testing/code_quality.html

stages:
  - build
  - test
  - deploy
  - performance

.pack:
  stage: build
  image: node:12.13.0
  script:
    - yarn --frozen-lockfile
    - yarn webpack

.benchmark:
  stage: performance
  image: docker:git
  variables:
    K6_VERSION: 0.8.1
    K6_OPTIONS: ''
    K6_REPORT: 'performance.json'
    K6_SUITE: './dist'
  services:
    - docker:dind
  script:
    - wget https://github.com/grafana/xk6-browser/releases/download/v${K6_VERSION}/xk6-browser-v${K6_VERSION}-linux-amd64.tar.gz
    - tar xf xk6-browser-v${K6_VERSION}-linux-amd64.tar.gz
    - |
      for K6_CASE in $(find ${K6_SUITE} -type f -name "*.js"); do
        K6_BROWSER_ENABLED=true ./xk6-browser-v${K6_VERSION}-linux-amd64//xk6-browser  \
            run ${K6_CASE}                                          \
            --summary-export=${K6_REPORT}                           \
            ${K6_OPTIONS}
      done
